services:
  stt-api:
    env_file:
      - .env
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stt-api
    ports:
      - "9091:9090"
    volumes:
      - "~/.cache/huggingface:/root/.cache/huggingface"
      - "./app:/app/app"
      - stt-venv:/app/.venv
    environment:
      - PYTHONUNBUFFERED=1
      - OMP_NUM_THREADS=2
      - OPENBLAS_NUM_THREADS=2
      - MKL_NUM_THREADS=2
      - VAD_WORKERS=4
      - MAX_CONCURRENT_REQUESTS=50
      - MAX_CONCURRENT_UPSTREAM=100
      - STT_API_URL=http://stt-engine:9090
      - OSD_API_URL=http://osd-osd-1:8000
      - ENABLE_ONLINE_DIARIZATION=true
      - SPEAKER_EMBEDDING_BATCH_SIZE=16
      - SPEAKER_PRECISION_MODE=FP16
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    working_dir: /app
    command: uv run uvicorn app.main:app --host 0.0.0.0 --port 9090 --workers 1
    networks:
      - stt-network

  stress-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stt-stress-test
    volumes:
      - "./stress_test.py:/app/stress_test.py"
      - "./test_audio:/app/test_audio"
      - stt-venv:/app/.venv
    environment:
      - PYTHONUNBUFFERED=1
      - STT_API_URL=http://stt-api:9090
      - AUDIO_FILE=/app/test_audio/masak.mp3
      - CONCURRENCY=50
      - WARMUP_COUNT=3
      # Diarization config (none, online, offline)
      - DIARIZATION_MODE=none
      - SPEAKER_SIMILARITY=0.75
      - SPEAKER_MAX_N=10
    working_dir: /app
    command: uv run python stress_test.py
    depends_on:
      - stt-api
    networks:
      - stt-network
    profiles:
      - test

networks:
  stt-network:
    external: true

volumes:
  stt-venv:
